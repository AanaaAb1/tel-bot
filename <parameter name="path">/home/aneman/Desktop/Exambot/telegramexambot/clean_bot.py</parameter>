<parameter name="content">#!/usr/bin/env python3
"""
Clean Bot Runner - NO DUPLICATE HANDLERS
This file starts the bot with ONLY ONE admin handler to prevent multiple messages.
"""

import asyncio
import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters

# Import handlers
from app.handlers.start_handler import start
from app.handlers.menu_handler import menu
from app.handlers.admin_handler import admin_panel
from app.handlers.register_handler import register
from app.handlers.exam_handler import exam_menu
from app.handlers.course_handler import course_menu
from app.handlers.practice_handler import practice_menu
from app.handlers.payment_handler import payment_menu
from app.handlers.materials_handler import materials_menu
from app.handlers.leaderboard_handler import leaderboard
from app.handlers.help_handler import help_menu
from app.handlers.question_handler import question_handler
from app.handlers.result_handler import result_handler

from app.config.settings import BOT_TOKEN
from app.config.constants import ADMIN_IDS

# Enable logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', 
    level=logging.INFO
)
logger = logging.getLogger(__name__)

async def admin_panel_handler(update: Update, context):
    """ONLY admin panel handler - NO DUPLICATES"""
    query = update.callback_query
    await query.answer()
    
    if update.effective_user.id in ADMIN_IDS:
        return await admin_panel(update, context)
    else:
        await query.answer("Access denied. Admin privileges required.")
        return

async def main():
    """Main bot function with SINGLE admin handler"""
    application = Application.builder().token(BOT_TOKEN).build()
    
    # Command handlers
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("admin", admin_panel_handler))
    application.add_handler(CommandHandler("register", register))
    
    # SINGLE admin callback handler - THIS IS THE ONLY ONE!
    application.add_handler(CallbackQueryHandler(admin_panel_handler, pattern="^admin$"))
    
    # Other callback handlers
    application.add_handler(CallbackQueryHandler(menu, pattern="^(exams|payment|materials|help|analytics|back_to_main|courses)$"))
    application.add_handler(CallbackQueryHandler(exam_menu, pattern="^exam_"))
    application.add_handler(CallbackQueryHandler(course_menu, pattern="^course_"))
    application.add_handler(CallbackQueryHandler(practice_menu, pattern="^practice_"))
    application.add_handler(CallbackQueryHandler(payment_menu, pattern="^payment_"))
    application.add_handler(CallbackQueryHandler(materials_menu, pattern="^materials_"))
    application.add_handler(CallbackQueryHandler(leaderboard, pattern="^leaderboard$"))
    application.add_handler(CallbackQueryHandler(question_handler, pattern="^q_"))
    application.add_handler(CallbackQueryHandler(result_handler, pattern="^result_"))
    
    # Text message handler
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, menu))
    
    logger.info("Bot started with CLEAN single admin handler")
    await application.run_polling()

if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("Bot stopped by user")
    except Exception as e:
        logger.error(f"Bot error: {e}")</parameter>
