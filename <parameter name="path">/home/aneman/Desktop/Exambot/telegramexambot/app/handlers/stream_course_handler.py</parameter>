<parameter name="content">"""
Stream-Specific Course Handler
Shows different courses based on user's stream during registration
"""

import logging
from telegram import Update
from telegram.ext import ContextTypes, CallbackQueryHandler
from app.database.session import SessionLocal
from app.models.user import User
from app.keyboards.stream_course_keyboard import get_stream_courses_keyboard, get_stream_courses_message

logger = logging.getLogger(__name__)

async def stream_course_selection(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle stream-specific course selection"""
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    
    try:
        db = SessionLocal()
        user = db.query(User).filter(User.user_id == str(user_id)).first()
        
        if not user:
            await query.edit_message_text("‚ùå User not found. Please register first.")
            return
        
        # Get user's stream
        user_stream = getattr(user, 'stream', None)
        if not user_stream:
            await query.edit_message_text("‚ùå Stream not set. Please complete registration.")
            return
        
        # Get appropriate keyboard and message based on stream
        keyboard = get_stream_courses_keyboard(user_stream)
        message = get_stream_courses_message(user_stream)
        
        await query.edit_message_text(
            text=message,
            reply_markup=keyboard,
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"Error in stream course selection: {e}")
        await query.edit_message_text("‚ùå An error occurred. Please try again.")
    finally:
        db.close()

async def handle_stream_course_selected(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle course selection within a stream"""
    query = update.callback_query
    await query.answer()
    
    course_code = query.data.replace("stream_course_", "")
    
    # Course name mapping for display
    course_names = {
        "bio": "Biology",
        "physics": "Physics",
        "chemistry": "Chemistry", 
        "english": "English",
        "maths": "Mathematics",
        "geography": "Geography",
        "history": "History"
    }
    
    course_name = course_names.get(course_code, course_code.title())
    
    # Show course-specific menu (exams/practice/materials)
    from app.keyboards.course_menu_keyboard import get_course_menu_keyboard
    from app.keyboards.admin_keyboard import get_back_button
    
    keyboard = get_course_menu_keyboard(course_code, course_name)
    keyboard.append(get_back_button())
    
    await query.edit_message_text(
        f"üìö **{course_name}**\n\nChoose an option:",
        reply_markup=keyboard,
        parse_mode='Markdown'
    )

def register_stream_course_handlers(application):
    """Register stream-specific course handlers"""
    application.add_handler(CallbackQueryHandler(
        stream_course_selection, 
        pattern="^exams$"
    ))
    application.add_handler(CallbackQueryHandler(
        handle_stream_course_selected, 
        pattern="^stream_course_"
    ))
</parameter>
