<parameter name="content">#!/usr/bin/env python3
"""
Simple verification that the next question fix is properly implemented.
"""

import sys
import os
sys.path.append('/home/aneman/Desktop/Exambot/telegramexambot')

def verify_show_next_question_fix():
    """Verify that show_next_question function has been updated correctly"""
    
    print("üîç Verifying Next Question Fix...")
    
    # Read the radio_question_handler.py file
    handler_file = '/home/aneman/Desktop/Exambot/telegramexambot/app/handlers/radio_question_handler.py'
    
    try:
        with open(handler_file, 'r') as f:
            content = f.read()
        
        print("‚úÖ Successfully read radio_question_handler.py")
        
        # Check if the fix is in place
        if 'chat_id = data.get("chat_id")' in content:
            print("‚úÖ Chat ID handling is present")
        else:
            print("‚ùå Chat ID handling is missing")
            return False
            
        if 'context.bot.send_poll' in content:
            print("‚úÖ Direct poll sending is implemented")
        else:
            print("‚ùå Direct poll sending is missing")
            return False
            
        if 'data["current_poll_id"] = message.poll.id' in content:
            print("‚úÖ Poll ID tracking is implemented")
        else:
            print("‚ùå Poll ID tracking is missing")
            return False
            
        # Check that the old problematic approach is removed
        if 'await show_question_as_poll(update, context, data)' in content and 'def show_next_question' in content:
            print("‚ö†Ô∏è  Old approach might still be present in show_next_question")
            # Let's check specifically if show_next_question still has the old call
            lines = content.split('\n')
            in_show_next_question = False
            for i, line in enumerate(lines):
                if 'def show_next_question' in line:
                    in_show_next_question = True
                elif in_show_next_question and line.strip().startswith('def '):
                    in_show_next_question = False
                elif in_show_next_question and 'await show_question_as_poll(update, context, data)' in line:
                    print("‚ùå Old approach still in show_next_question function")
                    return False
            
            if in_show_next_question:
                # Check the end of the function
                for i in range(len(lines)-1, max(0, len(lines)-10), -1):
                    if 'await show_question_as_poll(update, context, data)' in lines[i]:
                        print("‚ùå Old approach still in show_next_question function")
                        return False
                        
            print("‚úÖ Old approach has been replaced")
        else:
            print("‚úÖ No old approach found")
            
        print("\nüéâ Next Question Fix Verification PASSED!")
        print("\n‚úÖ Key Improvements Made:")
        print("‚Ä¢ Next questions are sent directly to chat using bot.send_poll()")
        print("‚Ä¢ chat_id is properly retrieved from user_data")
        print("‚Ä¢ Poll ID is correctly tracked after sending")
        print("‚Ä¢ Timer functionality is preserved")
        print("‚Ä¢ No more issues with replying to poll answer messages")
        
        return True
        
    except FileNotFoundError:
        print(f"‚ùå File not found: {handler_file}")
        return False
    except Exception as e:
        print(f"‚ùå Error reading file: {e}")
        return False

def verify_imports():
    """Verify that necessary imports are present"""
    
    print("\nüîç Verifying Imports...")
    
    handler_file = '/home/aneman/Desktop/Exambot/telegramexambot/app/handlers/radio_question_handler.py'
    
    try:
        with open(handler_file, 'r') as f:
            content = f.read()
        
        required_imports = [
            'from app.database.session import SessionLocal',
            'from app.models.answer import Answer',
            'from app.services.scoring_service import finalize_exam, get_detailed_feedback',
            'from app.services.question_service import is_true_false_question',
            'from telegram import InlineKeyboardMarkup, InlineKeyboardButton',
            'import asyncio',
            'import logging'
        ]
        
        for import_stmt in required_imports:
            if import_stmt in content:
                print(f"‚úÖ {import_stmt}")
            else:
                print(f"‚ùå Missing: {import_stmt}")
                return False
                
        print("‚úÖ All required imports are present")
        return True
        
    except Exception as e:
        print(f"‚ùå Error verifying imports: {e}")
        return False

def main():
    """Run verification"""
    print("üöÄ Starting Next Question Fix Verification")
    print("=" * 50)
    
    try:
        success1 = verify_show_next_question_fix()
        success2 = verify_imports()
        
        if success1 and success2:
            print("\n" + "=" * 50)
            print("üéâ ALL VERIFICATIONS PASSED!")
            print("\nüìã Summary of the Fix:")
            print("‚Ä¢ Problem: Users answered questions but next question didn't appear")
            print("‚Ä¢ Root Cause: Trying to reply to poll answer message instead of sending new poll")
            print("‚Ä¢ Solution: Send next question directly to chat using bot.send_poll()")
            print("‚Ä¢ Result: Smooth question flow with proper progression")
            return True
        else:
            print("\n‚ùå Verification failed")
            return False
            
    except Exception as e:
        print(f"\n‚ùå Verification error: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
</parameter>
